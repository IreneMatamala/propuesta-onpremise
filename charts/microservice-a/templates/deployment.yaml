apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "microservice-a.fullname" . }}
  namespace: {{ .Values.namespace | default "default" }}
  labels:
    {{- include "microservice-a.labels" . | nindent 4 }}
    {{- with .Values.deployment.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    # Anotaciones para rollback y versionado
    deployment.kubernetes.io/revision: "{{ .Chart.Version }}"
    helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    # Anotaciones para Prometheus scraping
    prometheus.io/scrape: "true"
    prometheus.io/port: "{{ .Values.service.port }}"
    prometheus.io/path: "/metrics"
    # Anotaciones para logging
    fluentd.io/parser: "json"
spec:
  replicas: {{ .Values.replicaCount }}
  revisionHistoryLimit: {{ .Values.revisionHistoryLimit | default 10 }}
  selector:
    matchLabels:
      {{- include "microservice-a.selectorLabels" . | nindent 6 }}
  strategy:
    type: {{ .Values.strategy.type }}
    {{- if eq .Values.strategy.type "RollingUpdate" }}
    rollingUpdate:
      maxSurge: {{ .Values.strategy.rollingUpdate.maxSurge }}
      maxUnavailable: {{ .Values.strategy.rollingUpdate.maxUnavailable }}
    {{- end }}
  minReadySeconds: {{ .Values.strategy.minReadySeconds | default 30 }}
  template:
    metadata:
      labels:
        {{- include "microservice-a.selectorLabels" . | nindent 8 }}
        version: {{ .Chart.AppVersion | default .Chart.Version | quote }}
        environment: {{ .Values.environment | quote }}
      annotations:
        # Checksum de ConfigMap para reiniciar pods cuando cambia la configuración
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        # Configuración de k8s sidecar para logging
        fluentbit.io/parser: "json"
        # Para Linkerd/Service Mesh (opcional)
        linkerd.io/inject: {{ .Values.linkerd.inject | default "disabled" | quote }}
    spec:
      serviceAccountName: {{ include "microservice-a.serviceAccountName" . | default "default" }}
      automountServiceAccountToken: {{ .Values.automountServiceAccountToken | default false }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      initContainers:
      {{- if .Values.initContainers.enabled }}
      - name: init-db-check
        image: "{{ .Values.initContainers.image }}:{{ .Values.initContainers.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        command: ['sh', '-c', 'until nc -z {{ .Values.database.host }} {{ .Values.database.port }}; do echo waiting for database; sleep 2; done;']
        securityContext:
          runAsUser: 1000
          runAsNonRoot: true
      {{- end }}
      containers:
      - name: {{ .Chart.Name }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.service.containerPort | default .Values.service.port }}
          protocol: TCP
        - name: metrics
          containerPort: 9100
          protocol: TCP
        env:
        # Variables de entorno del sistema Kubernetes
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        
        # Variables de entorno de la aplicación
        - name: ENVIRONMENT
          value: {{ .Values.environment | quote }}
        - name: APP_VERSION
          value: {{ .Chart.AppVersion | default .Chart.Version | quote }}
        
        # Configuración de base de datos
        - name: DB_HOST
          value: {{ .Values.database.host | quote }}
        - name: DB_PORT
          value: {{ .Values.database.port | quote | default "5432" }}
        - name: DB_NAME
          value: {{ .Values.database.name | quote }}
        - name: DB_USER
          value: {{ .Values.database.user | quote }}
        # CONTRASEÑA: Aquí NO ponemos la contraseña. Se maneja de otra forma:
        # 1. Usando un Secret existente (creado aparte)
        # 2. Usando External Secrets Operator
        # 3. Usando Vault Agent Injector (recomendado para producción)
        
        # Variables desde ConfigMap (no sensibles)
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: {{ include "microservice-a.fullname" . }}-config
              key: log_level
        - name: MAX_CONNECTIONS
          valueFrom:
            configMapKeyRef:
              name: {{ include "microservice-a.fullname" . }}-config
              key: max_connections
        
        # Variables desde Secrets (si existen)
        {{- if .Values.externalSecrets.enabled }}
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.externalSecrets.secretName | default (printf "%s-secrets" (include "microservice-a.fullname" .)) }}
              key: db_password
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.externalSecrets.secretName | default (printf "%s-secrets" (include "microservice-a.fullname" .)) }}
              key: secret_key
        {{- end }}
        
        # Resources y limites
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
        
        # Health checks - CRÍTICO para estabilidad
        livenessProbe:
          httpGet:
            path: {{ .Values.probes.liveness.path | default "/health" }}
            port: http
            scheme: HTTP
          initialDelaySeconds: {{ .Values.probes.liveness.initialDelaySeconds | default 30 }}
          periodSeconds: {{ .Values.probes.liveness.periodSeconds | default 10 }}
          timeoutSeconds: {{ .Values.probes.liveness.timeoutSeconds | default 3 }}
          successThreshold: {{ .Values.probes.liveness.successThreshold | default 1 }}
          failureThreshold: {{ .Values.probes.liveness.failureThreshold | default 3 }}
        
        readinessProbe:
          httpGet:
            path: {{ .Values.probes.readiness.path | default "/health" }}
            port: http
            scheme: HTTP
          initialDelaySeconds: {{ .Values.probes.readiness.initialDelaySeconds | default 10 }}
          periodSeconds: {{ .Values.probes.readiness.periodSeconds | default 5 }}
          timeoutSeconds: {{ .Values.probes.readiness.timeoutSeconds | default 2 }}
          successThreshold: {{ .Values.probes.readiness.successThreshold | default 1 }}
          failureThreshold: {{ .Values.probes.readiness.failureThreshold | default 3 }}
        
        startupProbe:
          httpGet:
            path: {{ .Values.probes.startup.path | default "/health" }}
            port: http
            scheme: HTTP
          initialDelaySeconds: {{ .Values.probes.startup.initialDelaySeconds | default 5 }}
          periodSeconds: {{ .Values.probes.startup.periodSeconds | default 5 }}
          timeoutSeconds: {{ .Values.probes.startup.timeoutSeconds | default 2 }}
          failureThreshold: {{ .Values.probes.startup.failureThreshold | default 30 }}
        
        # Security Context del contenedor
        securityContext:
          {{- toYaml .Values.securityContext | nindent 10 }}
        
        # Volúmenes para logging y configuraciones
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
          readOnly: true
        - name: logs-volume
          mountPath: /var/log/app
        - name: tmp-volume
          mountPath: /tmp
        
        # Lifecycle hooks
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "echo 'Graceful shutdown initiated'; sleep 30"]
      
      # Volúmenes
      volumes:
      - name: config-volume
        configMap:
          name: {{ include "microservice-a.fullname" . }}-config
      - name: logs-volume
        emptyDir: {}
      - name: tmp-volume
        emptyDir:
          medium: Memory
          sizeLimit: {{ .Values.volumes.tmp.sizeLimit | default "100Mi" }}
      
      # Configuración de red
      dnsConfig:
        options:
        - name: ndots
          value: "2"
        - name: single-request-reopen
      
      # DNS Policy
      dnsPolicy: ClusterFirst
      
      # Restart policy
      restartPolicy: Always
      
      # Terminación grace period
      terminationGracePeriodSeconds: {{ .Values.terminationGracePeriodSeconds | default 60 }}
      
      # Node selector y tolerancias
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      # Prioridad del pod (opcional)
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName }}
      {{- end }}

---
# Horizontal Pod Autoscaler (Opcional - separado)
{{- if .Values.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "microservice-a.fullname" . }}-hpa
  namespace: {{ .Values.namespace | default "default" }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "microservice-a.fullname" . }}
  minReplicas: {{ .Values.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.maxReplicas }}
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.targetCPUUtilizationPercentage }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.targetMemoryUtilizationPercentage }}
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 60
{{- end }}
